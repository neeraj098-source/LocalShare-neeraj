<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instant Share âš¡</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #f0f2f5; padding: 20px; color: #333; }
        .container { background: white; max-width: 500px; margin: auto; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { margin-bottom: 10px; color: #2c3e50; }
        #qr-box { margin: 20px auto; display: flex; justify-content: center; }
        .hidden { display: none; }
        
        /* Upload Button Styling */
        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; margin-top: 20px; }
        .btn { border: 2px solid gray; color: gray; background-color: white; padding: 8px 20px; border-radius: 8px; font-size: 20px; font-weight: bold; cursor: pointer; }
        .upload-btn-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
        .btn-primary { border-color: #3ecf8e; color: #3ecf8e; }
        .btn-primary:hover { background: #3ecf8e; color: white; }

        /* File List */
        #file-list { text-align: left; margin-top: 20px; }
        .file-item { background: #f8f9fa; padding: 10px; border-bottom: 1px solid #ddd; border-radius: 5px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; animation: popIn 0.3s ease; }
        .file-item a { text-decoration: none; color: #007bff; font-weight: bold; word-break: break-all; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .status { font-size: 0.9em; color: #666; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ðŸš€ Instant Share</h1>
    <p class="status" id="status-text">Connecting...</p>

    <div id="laptop-view">
        <p>Scan to Connect & Share Files</p>
        <div id="qr-box"></div>
        <h3>Received Files:</h3>
        <div id="file-list"></div>
    </div>

    <div id="phone-view" class="hidden">
        <p>âœ… Connected to Laptop</p>
        <div class="upload-btn-wrapper">
            <button class="btn btn-primary">Select File to Send ðŸ“¤</button>
            <input type="file" id="fileInput">
        </div>
        <p id="upload-status" style="margin-top:10px; font-size: 14px;"></p>
    </div>
</div>

<script>
    // --- 1. CONFIGURATION (Yahan apni details dalo) ---
    const SUPABASE_URL = 'https://ukpvztdunvjkixuofamn.supabase.co'; // Example: https://xyz.supabase.co
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVrcHZ6dGR1bnZqa2l4dW9mYW1uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNjc1MTcsImV4cCI6MjA4Njc0MzUxN30.GaRMs_HKyX8RfxAEnrzElR0yHy2LyLSeo73oud7JrgA';   // Example: eyJhbGciOiJIUzI1NiIsInR...

    // Initialize Supabase
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- 2. LOGIC START ---
    const urlParams = new URLSearchParams(window.location.search);
    let sessionID = urlParams.get('session');
    
    // Check agar hum Laptop par hain ya Phone par
    if (!sessionID) {
        // === LAPTOP MODE ===
        sessionID = Math.random().toString(36).substring(2, 10); // Generate Random ID
        document.getElementById('status-text').innerText = `Session ID: ${sessionID}`;
        
        // QR Code Generate karo
        const currentUrl = window.location.href.split('?')[0];
        const connectUrl = `${currentUrl}?session=${sessionID}`;
        new QRCode(document.getElementById("qr-box"), { text: connectUrl, width: 180, height: 180 });

        // Realtime Listener: Database me nayi file aayi kya?
        supabase
            .channel('public:transfers')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'transfers', filter: `session_id=eq.${sessionID}` }, payload => {
                displayFile(payload.new);
            })
            .subscribe();

    } else {
        // === PHONE MODE ===
        document.getElementById('laptop-view').classList.add('hidden');
        document.getElementById('phone-view').classList.remove('hidden');
        document.getElementById('status-text').innerText = "Ready to Upload";

        // File Upload Logic
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const status = document.getElementById('upload-status');
            status.innerText = "Uploading... â³";
            status.style.color = "orange";

            // A. File Upload to Supabase Storage
            const fileName = Date.now() + '_' + file.name;
            const { data, error } = await supabase.storage.from('uploads').upload(fileName, file);

            if (error) {
                status.innerText = "Error: " + error.message;
                status.style.color = "red";
            } else {
                // B. Get Public URL
                const { data: publicUrlData } = supabase.storage.from('uploads').getPublicUrl(fileName);
                const fileUrl = publicUrlData.publicUrl;

                // C. Save Link to Database (Taaki Laptop ko pata chale)
                await supabase.from('transfers').insert([
                    { session_id: sessionID, file_name: file.name, file_url: fileUrl }
                ]);

                status.innerText = "Sent Successfully! âœ…";
                status.style.color = "green";
                setTimeout(() => status.innerText = "", 3000);
            }
        });
    }

    // Helper: Screen par file dikhane ke liye
    function displayFile(record) {
        const list = document.getElementById('file-list');
        const item = document.createElement('div');
        item.className = 'file-item';
        item.innerHTML = `
            <span>ðŸ“„</span>
            <div>
                <div>${record.file_name}</div>
                <a href="${record.file_url}" target="_blank" download>Download</a>
            </div>
        `;
        list.prepend(item);
    }
</script>

</body>
</html>